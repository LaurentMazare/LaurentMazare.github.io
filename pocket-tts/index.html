<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pocket TTS - WebAssembly Demo</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; max-width: 640px; margin: 40px auto; padding: 0 20px; color: #222; }
  h1 { margin-bottom: 8px; }
  .subtitle { color: #666; margin-bottom: 24px; }
  .section { margin-bottom: 20px; }
  label { display: block; font-weight: 600; margin-bottom: 6px; }
  select, textarea, button { font-family: inherit; font-size: 14px; }
  select { padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; }
  textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; }
  button { padding: 10px 24px; background: #2563eb; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
  button:disabled { background: #94a3b8; cursor: not-allowed; }
  button:hover:not(:disabled) { background: #1d4ed8; }
  #status { margin-top: 12px; padding: 10px; background: #f1f5f9; border-radius: 4px; font-size: 13px; white-space: pre-wrap; }
  .progress-bar { width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; margin-top: 6px; overflow: hidden; }
  .progress-bar .fill { height: 100%; background: #2563eb; transition: width 0.2s; }
  audio { width: 100%; margin-top: 12px; }
  .controls { display: flex; gap: 10px; align-items: end; }
  .controls .section { margin-bottom: 0; }
</style>
</head>
<body>

<h1>Pocket TTS</h1>
<p class="subtitle"><a href="https://github.com/kyutai-labs/pocket-tts" target="_blank"> Pocket TTS</a> running in the browser via WebAssembly using <a href="https://github.com/LaurentMazare/xn/tree/main/wasm-pocket-tts#wasm-pocket-tts" target="_blank">xn</a> </p>

<div class="section">
  <label for="text">Text to speak</label>
  <textarea id="text" rows="3">The quick brown fox jumps over the lazy dog.</textarea>
</div>

<div class="controls">
  <div class="section">
    <label for="voice">Voice</label>
    <select id="voice">
      <option value="alba" selected>Alba</option>
      <option value="marius">Marius</option>
      <option value="javert">Javert</option>
      <option value="fantine">Fantine</option>
      <option value="cosette">Cosette</option>
      <option value="eponine">Eponine</option>
      <option value="azelma">Azelma</option>
    </select>
  </div>
  <button id="load-btn">Load Weights</button>
  <button id="generate-btn" style="display:none">Generate</button>
</div>

<div class="progress-bar" id="progress-bar" style="display:none"><div class="fill" id="progress-fill"></div></div>
<div id="status"></div>
<div id="audio-container"></div>

<script type="module">
const statusEl = document.getElementById('status');
const loadBtn = document.getElementById('load-btn');
const btn = document.getElementById('generate-btn');
const voiceSelect = document.getElementById('voice');
const progressBar = document.getElementById('progress-bar');
const progressFill = document.getElementById('progress-fill');

function log(msg) {
  statusEl.textContent = msg;
  console.log(msg);
}

function showProgress(pct) {
  progressBar.style.display = 'block';
  progressFill.style.width = pct + '%';
}

function hideProgress() {
  progressBar.style.display = 'none';
}

// ---- Worker setup ----
const worker = new Worker('worker.js', { type: 'module' });

let sampleRate = 24000;
let audioCtx = null;
let nextStartTime = 0;
let startTime = 0;
let firstChunkTime = null;
let allChunks = [];
let generating = false;

worker.onmessage = (e) => {
  const { type, ...data } = e.data;

  switch (type) {
    case 'status':
      log(data.message);
      break;

    case 'progress':
      if (data.pct >= 0) {
        log(`${data.label}: ${data.pct}% (${data.detail})`);
        showProgress(data.pct);
      } else {
        log(`${data.label}: ${data.detail}`);
      }
      break;

    case 'progress_done':
      hideProgress();
      break;

    case 'loaded':
      sampleRate = data.sampleRate;
      loadBtn.style.display = 'none';
      btn.style.display = '';
      log('Ready! Enter text and click Generate.');
      break;

    case 'gen_start':
      log(`Generating speech (${data.numTokens} tokens)...`);
      break;

    case 'chunk': {
      const chunk = new Float32Array(data.data);
      if (!firstChunkTime) {
        firstChunkTime = performance.now() - startTime;
        // Set start time relative to now for the first chunk
        nextStartTime = audioCtx.currentTime;
      }

      // Ensure we never schedule in the past
      nextStartTime = Math.max(nextStartTime, audioCtx.currentTime);

      const buf = audioCtx.createBuffer(1, chunk.length, sampleRate);
      buf.getChannelData(0).set(chunk);
      const src = audioCtx.createBufferSource();
      src.buffer = buf;
      src.connect(audioCtx.destination);
      src.start(nextStartTime);
      nextStartTime += chunk.length / sampleRate;

      allChunks.push(chunk);
      break;
    }

    case 'done': {
      const totalTime = ((performance.now() - startTime) / 1000).toFixed(2);
      const totalSamples = allChunks.reduce((sum, c) => sum + c.length, 0);
      const duration = (totalSamples / sampleRate).toFixed(2);
      const firstAudio = firstChunkTime != null ? (firstChunkTime / 1000).toFixed(2) : '?';
      log(`Generated ${duration}s of audio in ${totalTime}s (first audio: ${firstAudio}s)`);

      // Create WAV download/replay element
      const allPcm = concatenateChunks(allChunks);
      const wavBlob = encodeWav(allPcm, sampleRate);
      const url = URL.createObjectURL(wavBlob);
      const container = document.getElementById('audio-container');
      container.innerHTML = '';
      const audio = document.createElement('audio');
      audio.controls = true;
      audio.src = url;
      container.appendChild(audio);

      btn.disabled = false;
      generating = false;
      break;
    }

    case 'error':
      log('Error: ' + data.message);
      console.error(data.message);
      btn.disabled = false;
      generating = false;
      break;
  }
};

function concatenateChunks(chunks) {
  const totalLength = chunks.reduce((sum, c) => sum + c.length, 0);
  const result = new Float32Array(totalLength);
  let offset = 0;
  for (const chunk of chunks) {
    result.set(chunk, offset);
    offset += chunk.length;
  }
  return result;
}

function loadWeights() {
  loadBtn.disabled = true;
  worker.postMessage({ type: 'load', voiceName: voiceSelect.value });
}

function generate() {
  const text = document.getElementById('text').value.trim();
  if (!text || generating) return;

  generating = true;
  btn.disabled = true;
  startTime = performance.now();
  firstChunkTime = null;
  allChunks = [];

  // AudioContext must be created/resumed from a user gesture
  audioCtx = new AudioContext({ sampleRate });

  worker.postMessage({
    type: 'generate',
    text,
    voiceName: voiceSelect.value,
    temperature: 0.7,
  });
}

function encodeWav(samples, sampleRate) {
  const numChannels = 1;
  const bitsPerSample = 16;
  const byteRate = sampleRate * numChannels * bitsPerSample / 8;
  const blockAlign = numChannels * bitsPerSample / 8;
  const dataSize = samples.length * blockAlign;
  const buffer = new ArrayBuffer(44 + dataSize);
  const view = new DataView(buffer);

  function writeString(offset, str) {
    for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
  }

  writeString(0, 'RIFF');
  view.setUint32(4, 36 + dataSize, true);
  writeString(8, 'WAVE');
  writeString(12, 'fmt ');
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true); // PCM
  view.setUint16(22, numChannels, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, byteRate, true);
  view.setUint16(32, blockAlign, true);
  view.setUint16(34, bitsPerSample, true);
  writeString(36, 'data');
  view.setUint32(40, dataSize, true);

  let offset = 44;
  for (let i = 0; i < samples.length; i++) {
    let s = Math.max(-1, Math.min(1, samples[i]));
    s = s < 0 ? s * 0x8000 : s * 0x7FFF;
    view.setInt16(offset, s, true);
    offset += 2;
  }

  return new Blob([buffer], { type: 'audio/wav' });
}

loadBtn.addEventListener('click', loadWeights);
btn.addEventListener('click', generate);
</script>
</body>
</html>
